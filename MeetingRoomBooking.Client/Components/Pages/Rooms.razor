@page "/rooms"
@using Microsoft.AspNetCore.Authorization
@using static Microsoft.AspNetCore.Components.Web.RenderMode
@using MeetingRoomBooking.Api.Models
@using MeetingRoomBooking.Client.Providers

@rendermode InteractiveServer
@inject NavigationManager Nav

@inject BookingProvider _bookingProvider
@inject RoomProvider _roomProvider

<style>
    * {
        box-sizing: border-box;
    }

    .dashboard-container {
        padding: 30px;
        background:  #FFFFFF ;
        min-height: 100vh;
        font-family: 'Sarabun', 'Segoe UI', sans-serif;
    }

    .page-header {
        background: rgba(255, 255, 255, 0.95);
        padding: 25px 30px;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

        .page-header h4 {
            margin: 0;
            font-size: 28px;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

    .room-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 20px;
        padding: 10px 0;
    }

    .room-box {
        height: 180px;
        border-radius: 16px;
        color: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        position: relative;
        text-align: center;
        padding: 20px;
        overflow: hidden;
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }

        .room-box::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .room-box:hover::before {
            opacity: 1;
        }

        .room-box:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.25);
        }

    .status-available {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }

    .status-occupied {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        color: #333;
        cursor: not-allowed;
    }

        .status-occupied:hover {
            transform: none;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

    .room-name {
        font-size: 26px;
        font-weight: 700;
        margin-bottom: 10px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .room-info {
        font-size: 14px;
        opacity: 0.95;
        margin-bottom: 5px;
        font-weight: 500;
    }

    .status-badge {
        margin-top: 10px;
        font-weight: 600;
        font-size: 13px;
        background: rgba(255, 255, 255, 0.3);
        padding: 6px 16px;
        border-radius: 20px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.4);
    }

    /* Modal CSS */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(5px);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        animation: fadeIn 0.2s ease-out;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @@keyframes slideUp {
        from {
            transform: translateY(30px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .modal-content {
        background: white;
        width: 90%;
        max-width: 520px;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s ease-out;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
    }

    .modal-title {
        font-size: 24px;
        font-weight: 700;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .close-btn {
        background: #f5f5f5;
        border: none;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        font-size: 20px;
        cursor: pointer;
        color: #666;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

        .close-btn:hover {
            background: #e0e0e0;
            transform: rotate(90deg);
        }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
        font-size: 14px;
    }

    .form-control {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 15px;
        transition: all 0.2s;
        font-family: 'Sarabun', sans-serif;
    }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

    .time-inputs {
        display: flex;
        gap: 15px;
    }

        .time-inputs .form-group {
            flex: 1;
        }

    .btn-submit {
        width: 100%;
        padding: 14px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        margin-top: 10px;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

        .btn-submit:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .btn-submit:disabled {
            background: linear-gradient(135deg, #ccc 0%, #999 100%);
            cursor: not-allowed;
            box-shadow: none;
        }

    .alert {
        padding: 12px 16px;
        border-radius: 10px;
        margin-bottom: 15px;
        font-weight: 500;
    }

    .alert-error {
        background: #fee;
        color: #c33;
        border-left: 4px solid #c33;
    }

    .alert-success {
        background: #efe;
        color: #3c3;
        border-left: 4px solid #3c3;
    }
</style>

<div class="dashboard-container">
    <div class="page-header">
        <h4>🏢 รายการห้องประชุม</h4>
    </div>

    <div class="room-grid">
        @foreach (var item in roomList)
        {
            <div class="room-box @(item.IsAvailable ? "status-available" : "status-occupied")"
                 @onclick="() => OpenBookingModal(item)">

                <div class="room-name">@item.Room.Name</div>
                <div class="room-info">👥 @item.Room.Capacity คน</div>
                <div class="room-info">💻 @(string.IsNullOrEmpty(item.Room.Equipment) ? "อุปกรณ์พื้นฐาน" : item.Room.Equipment)</div>

                <div class="status-badge">
                    @(item.IsAvailable ? " ว่าง" : " ไม่ว่าง")
                </div>
            </div>
        }
    </div>
</div>

@if (showModal && selectedItem != null)
{
    <div class="modal-overlay" @onclick="CloseModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <div class="modal-title">📅 จองห้อง: @selectedItem.Room.Name</div>
                <button class="close-btn" @onclick="CloseModal">&times;</button>
            </div>

            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">📝 หัวข้อการประชุม</label>
                    <input class="form-control" @bind="bookingModel.Title" placeholder="ระบุหัวข้อการประชุม..." />
                </div>

                <div class="form-group">
                    <label class="form-label">📆 วันที่</label>
                    <input type="date" class="form-control" @bind="bookingDate" />
                </div>

                <div class="time-inputs">
                    <div class="form-group">
                        <label class="form-label">🕐 เริ่มเวลา</label>
                        <input type="time" class="form-control" @bind="startTime" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">🕐 ถึงเวลา</label>
                        <input type="time" class="form-control" @bind="endTime" />
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(errorMsg))
                {
                    <div class="alert alert-error">⚠️ @errorMsg</div>
                }

                @if (isSuccess)
                {
                    <div class="alert alert-success">🎉 จองสำเร็จ!</div>
                }

                <button class="btn-submit" @onclick="ConfirmBooking" disabled="@isLoading">
                    @if (isLoading)
                    {
                        <span>⏳ กำลังบันทึกข้อมูล...</span>
                    }
                    else
                    {
                        <span>✅ ยืนยันการจอง</span>
                    }
                </button>
            </div>
        </div>
    </div>
}

@code {
    public class RoomUiItem
    {
        public RoomModel Room { get; set; } = new();
        public bool IsAvailable { get; set; } = true;
    }

    private List<RoomUiItem> roomList = new();
    private bool showModal = false;
    private RoomUiItem? selectedItem;

    private CreateBookingDto bookingModel = new();
    private DateTime bookingDate = DateTime.Today;
    private TimeOnly? startTime;
    private TimeOnly? endTime;

    private bool isLoading = false;
    private bool isSuccess = false;
    private string? errorMsg;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var roomsFromDb = await _roomProvider.GetRoomsAsync();

            roomList = roomsFromDb.Select(r => new RoomUiItem
            {
                Room = r,
                IsAvailable = true
            }).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
    }

    private void OpenBookingModal(RoomUiItem item)
    {
        if (!item.IsAvailable) return;

        selectedItem = item;
        showModal = true;

        bookingModel = new CreateBookingDto { RoomId = item.Room.Id };
        bookingDate = DateTime.Today;
        startTime = null;
        endTime = null;
        errorMsg = null;
        isSuccess = false;
    }

    private void CloseModal() => showModal = false;

    private async Task ConfirmBooking()
    {
        errorMsg = null;

        if (string.IsNullOrWhiteSpace(bookingModel.Title)) { errorMsg = "กรุณาระบุหัวข้อ"; return; }
        if (startTime == null || endTime == null) { errorMsg = "กรุณาระบุเวลา"; return; }

        bookingModel.StartTime = bookingDate.Date.Add(startTime.Value.ToTimeSpan());
        bookingModel.EndTime = bookingDate.Date.Add(endTime.Value.ToTimeSpan());

        if (bookingModel.StartTime >= bookingModel.EndTime) { errorMsg = "เวลาไม่ถูกต้อง"; return; }

        isLoading = true;
        try
        {
            var success = await _bookingProvider.CreateBookingAsync(bookingModel);
            if (success)
            {
                isSuccess = true;
                StateHasChanged();
                await Task.Delay(1500);
                CloseModal();
            }
            else
            {
                errorMsg = "จองไม่สำเร็จ (ห้องอาจจะไม่ว่าง)";
            }
        }
        catch (Exception ex)
        {
            errorMsg = "Error: " + ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }
}